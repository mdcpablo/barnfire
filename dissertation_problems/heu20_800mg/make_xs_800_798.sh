#! /usr/bin/env bash 
# Pablo Vaquer, Summer Internship 2018 

############################ 
# INITIALIZE VARIABLES 
############################ 

## !!!!! 
# You need to set and export the following: 
# export SCRATCH_BARN=... 
# export ENDF=... 
# export NJOY=... 
## !!!!! 

# This is a resolution parameter used in indicators.py only. I usually just set it at 9.
res=9 

# This is the minimum bin width for a single sublement (use 1e-4 to avoid seg faulting in ERRORR)
bin=1.00e-16 

# In addition to coarse groups, I use energy penalties. 
# See my dissertation, Appendix B, section 1 for more details 
penalty=0 

# Which problem to run, materials-wise. 
# This is only used in indicators.py and indicators_clustering.py, 
# where there is a mapping from this string to a set of materials defined in 
# materials_materials.py. 
unimportantMatsExist=0 
m=HMF001 

# The specific list of materials to generate NJOY inputs for / read NJOY outputs from  
# This is only used in calls to materials.py 
mUNIMPORTANTlist=()  

# We need PENDF files for all the materials to do the clustering, 
# but we can only do half of the materials at a time due to incompatible 
# thermal treatments  
mIMPORTANTlist=(HMF001 )  

# How many elements to use in the resolved resonance region (RRR). 
g=798 

# These are the coarse-group boundaries in eV. c also specifies the extent of the RRR 
c=(1.0000000000e-03 1.0297088519e-03 1.0603003196e-03 1.0918006247e-03 1.1242367678e-03 1.1576365514e-03 1.1920286042e-03 1.2274424054e-03 1.2639083100e-03 1.3014575748e-03 1.3401223851e-03 1.3799358825e-03 1.4209321932e-03 1.4631464573e-03 1.5066148586e-03 1.5513746563e-03 1.5974642161e-03 1.6449230439e-03 1.6937918189e-03 1.7441124292e-03 1.7959280070e-03 1.8492829661e-03 1.9042230398e-03 1.9607953200e-03 2.0190482977e-03 2.0790319045e-03 2.1407975554e-03 2.2043981928e-03 2.2698883322e-03 2.3373241084e-03 2.4067633241e-03 2.4782654992e-03 2.5518919218e-03 2.6277057009e-03 2.7057718203e-03 2.7861571945e-03 2.8689307259e-03 2.9541633638e-03 3.0419281656e-03 3.1323003589e-03 3.2253574062e-03 3.3211790716e-03 3.4198474887e-03 3.5214472312e-03 3.6260653853e-03 3.7337916247e-03 3.8447182870e-03 3.9589404530e-03 4.0765560285e-03 4.1976658277e-03 4.3223736600e-03 4.4507864187e-03 4.5830141732e-03 4.7191702623e-03 4.8593713926e-03 5.0037377375e-03 5.1523930407e-03 5.3054647223e-03 5.4630839878e-03 5.6253859408e-03 5.7925096984e-03 5.9645985109e-03 6.1417998846e-03 6.3242657075e-03 6.5121523806e-03 6.7056209510e-03 6.9048372505e-03 7.1099720376e-03 7.3212011436e-03 7.5387056239e-03 7.7626719125e-03 7.9932919825e-03 8.2307635099e-03 8.4752900438e-03 8.7270811803e-03 8.9863527423e-03 9.2533269647e-03 9.5282326848e-03 9.8113055382e-03 1.0102788161e-02 1.0402930398e-02 1.0711989516e-02 1.1030230426e-02 1.1357925908e-02 1.1695356846e-02 1.2042812470e-02 1.2400590602e-02 1.2768997911e-02 1.3148350179e-02 1.3538972566e-02 1.3941199897e-02 1.4355376939e-02 1.4781858706e-02 1.5221010757e-02 1.5673209511e-02 1.6138842570e-02 1.6618309054e-02 1.7112019936e-02 1.7620398401e-02 1.8143880207e-02 1.8682914056e-02 1.9237961983e-02 1.9809499745e-02 2.0398017239e-02 2.1004018911e-02 2.1628024198e-02 2.2270567965e-02 2.2932200970e-02 2.3613490331e-02 2.4315020017e-02 2.5037391345e-02 2.5781223496e-02 2.6547154046e-02 2.7335839513e-02 2.8147955920e-02 2.8984199372e-02 2.9845286658e-02 3.0731955858e-02 3.1644966983e-02 3.2585102619e-02 3.3553168606e-02 3.4549994722e-02 3.5576435397e-02 3.6633370446e-02 3.7721705822e-02 3.8842374392e-02 3.9996336739e-02 4.1184581983e-02 4.2408128628e-02 4.3668025440e-02 4.4965352339e-02 4.6301221331e-02 4.7676777456e-02 4.9093199775e-02 5.0551702375e-02 5.2053535413e-02 5.3599986185e-02 5.5192380235e-02 5.6832082484e-02 5.8520498404e-02 6.0259075222e-02 6.2049303161e-02 6.3892716717e-02 6.5790895974e-02 6.7745467956e-02 6.9758108029e-02 7.1830541327e-02 7.3964544239e-02 7.6161945927e-02 7.8424629896e-02 8.0754535609e-02 8.3153660145e-02 8.5624059916e-02 8.8167852428e-02 9.0787218096e-02 9.3484402110e-02 9.6261716364e-02 9.9121541436e-02 1.0206632863e-01 1.0509860207e-01 1.0822096087e-01 1.1143608136e-01 1.1474671939e-01 1.1815571268e-01 1.2166598325e-01 1.2528053992e-01 1.2900248092e-01 1.3283499652e-01 1.3678137176e-01 1.4084498927e-01 1.4502933219e-01 1.4933798714e-01 1.5377464727e-01 1.5834311549e-01 1.6304730765e-01 1.6789125596e-01 1.7287911242e-01 1.7801515236e-01 1.8330377815e-01 1.8874952294e-01 1.9435705456e-01 2.0013117950e-01 2.0607684707e-01 2.1219915359e-01 2.1850334681e-01 2.2499483038e-01 2.3167916846e-01 2.3856209056e-01 2.4564949637e-01 2.5294746087e-01 2.6046223951e-01 2.6820027360e-01 2.7616819580e-01 2.8437283582e-01 2.9282122628e-01 3.0152060871e-01 3.1047843981e-01 3.1970239779e-01 3.2920038897e-01 3.3898055456e-01 3.4905127764e-01 3.5942119034e-01 3.7009918124e-01 3.8109440299e-01 3.9241628016e-01 4.0407451730e-01 4.1607910727e-01 4.2844033984e-01 4.4116881043e-01 4.5427542927e-01 4.6777143070e-01 4.8166838284e-01 4.9597819748e-01 5.1071314028e-01 5.2588584131e-01 5.4150930587e-01 5.5759692562e-01 5.7416249008e-01 5.9122019845e-01 6.0878467175e-01 6.2687096538e-01 6.4549458203e-01 6.6467148495e-01 6.8441811164e-01 7.0475138793e-01 7.2568874252e-01 7.4724812187e-01 7.6944800563e-01 7.9230742245e-01 8.1584596630e-01 8.4008381326e-01 8.6504173882e-01 8.9074113570e-01 9.1720403215e-01 9.4445311088e-01 9.7251172844e-01 1.0014039353e+00 1.0311544965e+00 1.0617889127e+00 1.0933334422e+00 1.1258151235e+00 1.1592617982e+00 1.1937021353e+00 1.2291656552e+00 1.2656827555e+00 1.3032847370e+00 1.3420038302e+00 1.3818732232e+00 1.4229270901e+00 1.4652006203e+00 1.5087300484e+00 1.5535526860e+00 1.5997069526e+00 1.6472324095e+00 1.6961697931e+00 1.7465610502e+00 1.7984493737e+00 1.8518792398e+00 1.9068964458e+00 1.9635481498e+00 2.0218829109e+00 2.0819507308e+00 2.1438030967e+00 2.2074930253e+00 2.2730751086e+00 2.3406055603e+00 2.4101422642e+00 2.4817448237e+00 2.5554746130e+00 2.6313948298e+00 2.7095705490e+00 2.7900687790e+00 2.8729585191e+00 2.9583108181e+00 3.0461988360e+00 3.1366979060e+00 3.2298855994e+00 3.3258417923e+00 3.4246487334e+00 3.5263911153e+00 3.6311561466e+00 3.7390336267e+00 3.8501160228e+00 3.9644985494e+00 4.0822792495e+00 4.2035590790e+00 4.3284419930e+00 4.4570350350e+00 4.5894484286e+00 4.7257956722e+00 4.8661936357e+00 5.0107626616e+00 5.1596266673e+00 5.3129132516e+00 5.4707538044e+00 5.6332836188e+00 5.8006420074e+00 5.9729724215e+00 6.1504225744e+00 6.3331445675e+00 6.5212950214e+00 6.7150352091e+00 6.9145311954e+00 7.1199539785e+00 7.3314796365e+00 7.5492894790e+00 7.7735702018e+00 8.0045140475e+00 8.2423189696e+00 8.4871888029e+00 8.7393334378e+00 8.9989690003e+00 9.2663180373e+00 9.5416097072e+00 9.8250799766e+00 1.0116971822e+01 1.0417535439e+01 1.0727028457e+01 1.1045716156e+01 1.1373871701e+01 1.1711776371e+01 1.2059719800e+01 1.2418000229e+01 1.2786924758e+01 1.3166809612e+01 1.3557980408e+01 1.3960772440e+01 1.4375530960e+01 1.4802611480e+01 1.5242380072e+01 1.5695213683e+01 1.6161500462e+01 1.6641640085e+01 1.7136044105e+01 1.7645136301e+01 1.8169353041e+01 1.8709143659e+01 1.9264970837e+01 1.9837311002e+01 2.0426654736e+01 2.1033507195e+01 2.1658388545e+01 2.2301834402e+01 2.2964396297e+01 2.3646642144e+01 2.4349156733e+01 2.5072542223e+01 2.5817418666e+01 2.6584424533e+01 2.7374217264e+01 2.8187473829e+01 2.9024891314e+01 2.9887187510e+01 3.0775101537e+01 3.1689394469e+01 3.2630849996e+01 3.3600275084e+01 3.4598500680e+01 3.5626382411e+01 3.6684801329e+01 3.7774664657e+01 3.8896906574e+01 4.0052489009e+01 4.1242402472e+01 4.2467666898e+01 4.3729332523e+01 4.5028480785e+01 4.6366225251e+01 4.7743712568e+01 4.9162123453e+01 5.0622673696e+01 5.2126615210e+01 5.3675237099e+01 5.5269866767e+01 5.6911871052e+01 5.8602657398e+01 6.0343675066e+01 6.2136416370e+01 6.3982417959e+01 6.5883262137e+01 6.7840578212e+01 6.9856043901e+01 7.1931386761e+01 7.4068385675e+01 7.6268872373e+01 7.8534733004e+01 8.0867909754e+01 8.3270402505e+01 8.5744270558e+01 8.8291634391e+01 9.0914677478e+01 9.3615648164e+01 9.6396861588e+01 9.9260701669e+01 1.0220962315e+02 1.0524615370e+02 1.0837289610e+02 1.1159253041e+02 1.1490781637e+02 1.1832159566e+02 1.2183679442e+02 1.2545642570e+02 1.2918359206e+02 1.3302148826e+02 1.3697340396e+02 1.4104272652e+02 1.4523294399e+02 1.4954764801e+02 1.5399053693e+02 1.5856541898e+02 1.6327621553e+02 1.6812696443e+02 1.7312182351e+02 1.7826507412e+02 1.8356112480e+02 1.8901451507e+02 1.9462991929e+02 2.0041215074e+02 2.0636616563e+02 2.1249706748e+02 2.1881011138e+02 2.2531070857e+02 2.3200443103e+02 2.3889701630e+02 2.4599437237e+02 2.5330258274e+02 2.6082791165e+02 2.6857680944e+02 2.7655591809e+02 2.8477207689e+02 2.9323232834e+02 3.0194392415e+02 3.1091433146e+02 3.2015123928e+02 3.2966256502e+02 3.3945646133e+02 3.4954132306e+02 3.5992579444e+02 3.7061877655e+02 3.8162943489e+02 3.9296720724e+02 4.0464181178e+02 4.1666325543e+02 4.2904184236e+02 4.4178818290e+02 4.5491320259e+02 4.6842815154e+02 4.8234461410e+02 4.9667451879e+02 5.1143014849e+02 5.2662415102e+02 5.4226954991e+02 5.5837975564e+02 5.7496857709e+02 5.9205023337e+02 6.0963936605e+02 6.2775105167e+02 6.4640081467e+02 6.6560464073e+02 6.8537899040e+02 7.0574081330e+02 7.2670756258e+02 7.4829720990e+02 7.7052826087e+02 7.9341977083e+02 8.1699136127e+02 8.4126323660e+02 8.6625620148e+02 8.9199167864e+02 9.1849172729e+02 9.4577906196e+02 9.7387707201e+02 1.0028098417e+03 1.0326021707e+03 1.0632795956e+03 1.0948684116e+03 1.1273956951e+03 1.1608893268e+03 1.1953780159e+03 1.2308913243e+03 1.2674596923e+03 1.3051144645e+03 1.3438879168e+03 1.3838132839e+03 1.4249247877e+03 1.4672576672e+03 1.5108482078e+03 1.5557337734e+03 1.6019528377e+03 1.6495450172e+03 1.6985511058e+03 1.7490131090e+03 1.8009742803e+03 1.8544791585e+03 1.9095736051e+03 1.9663048444e+03 2.0247215038e+03 2.0848736550e+03 2.1468128576e+03 2.2105922028e+03 2.2762663591e+03 2.3438916191e+03 2.4135259480e+03 2.4852290329e+03 2.5590623341e+03 2.6350891379e+03 2.7133746108e+03 2.7939858551e+03 2.8769919670e+03 2.9624640952e+03 3.0504755022e+03 3.1411016270e+03 3.2344201499e+03 3.3305110590e+03 3.4294567187e+03 3.5313419404e+03 3.6362540550e+03 3.7442829880e+03 3.8555213367e+03 3.9700644489e+03 4.0880105056e+03 4.2094606041e+03 4.3345188456e+03 4.4632924239e+03 4.5958917174e+03 4.7324303836e+03 4.8730254569e+03 5.0177974483e+03 5.1668704494e+03 5.3203722382e+03 5.4784343889e+03 5.6411923847e+03 5.8087857336e+03 5.9813580885e+03 6.1590573699e+03 6.3420358929e+03 6.5304504978e+03 6.7244626843e+03 6.9242387500e+03 7.1299499334e+03 7.3417725598e+03 7.5598881932e+03 7.7844837916e+03 8.0157518675e+03 8.2538906523e+03 8.4991042670e+03 8.7516028967e+03 9.0116029708e+03 9.2793273485e+03 9.5550055102e+03 9.8388737534e+03 1.0131175396e+04 1.0432160985e+04 1.0742088511e+04 1.1061223627e+04 1.1389839881e+04 1.1728218947e+04 1.2076650867e+04 1.2435434298e+04 1.2804876774e+04 1.3185294961e+04 1.3577014936e+04 1.3980372461e+04 1.4395713276e+04 1.4823393389e+04 1.5263779387e+04 1.5717248748e+04 1.6184190163e+04 1.6665003871e+04 1.7160102002e+04 1.7669908931e+04 1.8194861638e+04 1.8735410087e+04 1.9292017610e+04 1.9865161303e+04 2.0455332438e+04 2.1063036879e+04 2.1688795522e+04 2.2333144735e+04 2.2996636824e+04 2.3679840501e+04 2.4383341374e+04 2.5107742451e+04 2.5853664652e+04 2.6621747346e+04 2.7412648894e+04 2.8227047219e+04 2.9065640384e+04 2.9929147188e+04 3.0818307789e+04 3.1733884330e+04 3.2676661598e+04 3.3647447697e+04 3.4647074737e+04 3.5676399548e+04 3.6736304417e+04 3.7827697843e+04 3.8951515315e+04 4.0108720113e+04 4.1300304138e+04 4.2527288756e+04 4.3790725678e+04 4.5091697860e+04 4.6431320432e+04 4.7810741653e+04 4.9231143894e+04 5.0693744656e+04 5.2199797606e+04 5.3750593661e+04 5.5347462086e+04 5.6991771638e+04 5.8684931739e+04 6.0428393683e+04 6.2223651880e+04 6.4072245136e+04 6.5975757976e+04 6.7935821996e+04 6.9954117268e+04 7.2032373776e+04 7.4172372898e+04 7.6375948937e+04 7.8644990690e+04 8.0981443069e+04 8.3387308765e+04 8.5864649969e+04 8.8415590135e+04 9.1042315805e+04 9.3747078479e+04 9.6532196547e+04 9.9400057274e+04 1.0235311885e+05 1.0539391250e+05 1.0852504463e+05 1.1174919911e+05 1.1506913951e+05 1.1848771153e+05 1.2200784540e+05 1.2563255841e+05 1.2936495747e+05 1.3320824183e+05 1.3716570576e+05 1.4124074139e+05 1.4543684165e+05 1.4975760324e+05 1.5420672969e+05 1.5878803458e+05 1.6350544477e+05 1.6836300381e+05 1.7336487535e+05 1.7851534675e+05 1.8381883275e+05 1.8927987922e+05 1.9490316711e+05 2.0069351643e+05 2.0665589038e+05 2.1279539962e+05 2.1911730662e+05 2.2562703023e+05 2.3233015025e+05 2.3923241226e+05 2.4633973256e+05 2.5365820319e+05 2.6119409717e+05 2.6895387391e+05 2.7694418471e+05 2.8517187847e+05 2.9364400756e+05 3.0236783389e+05 3.1135083507e+05 3.2060071091e+05 3.3012538994e+05 3.3993303625e+05 3.5003205647e+05 3.6043110698e+05 3.7113910135e+05 3.8216521793e+05 3.9351890778e+05 4.0520990272e+05 4.1724822369e+05 4.2964418936e+05 4.4240842494e+05 4.5555187130e+05 4.6908579436e+05 4.8302179474e+05 4.9737181769e+05 5.1214816335e+05 5.2736349726e+05 5.4303086129e+05 5.5916368470e+05 5.7577579578e+05 5.9288143361e+05 6.1049526029e+05 6.2863237355e+05 6.4730831961e+05 6.6653910659e+05 6.8634121817e+05 7.0673162775e+05 7.2772781299e+05 7.4934777079e+05 7.7161003271e+05 7.9453368087e+05 8.1813836430e+05 8.4244431577e+05 8.6747236916e+05 8.9324397727e+05 9.1978123027e+05 9.4710687459e+05 9.7524433243e+05 1.0042177218e+06 1.0340518774e+06 1.0647723714e+06 1.0964055361e+06 1.1289784857e+06 1.1625191403e+06 1.1970562493e+06 1.2326194161e+06 1.2692391237e+06 1.3069467608e+06 1.3457746485e+06 1.3857560682e+06 1.4269252900e+06 1.4693176020e+06 1.5129693410e+06 1.5579179230e+06 1.6042018758e+06 1.6518608717e+06 1.7009357617e+06 1.7514686103e+06 1.8035027318e+06 1.8570827273e+06 1.9122545229e+06 1.9690654093e+06 2.0275640818e+06 2.0878006828e+06 2.1498268440e+06 2.2136957312e+06 2.2794620898e+06 2.3471822914e+06 2.4169143824e+06 2.4887181337e+06 2.5626550921e+06 2.6387886326e+06 2.7171840132e+06 2.7979084306e+06 2.8810310777e+06 2.9666232032e+06 3.0547581725e+06 3.1455115305e+06 3.2389610666e+06 3.3351868812e+06 3.4342714542e+06 3.5362997161e+06 3.6413591205e+06 3.7495397192e+06 3.8609342393e+06 3.9756381627e+06 4.0937498079e+06 4.2153704145e+06 4.3406042298e+06 4.4695585978e+06 4.6023440521e+06 4.7390744098e+06 4.8798668695e+06 5.0248421114e+06 5.1741244014e+06 5.3278416967e+06 5.4861257565e+06 5.6491122539e+06 5.8169408930e+06 5.9897555284e+06 6.1677042881e+06 6.3509397011e+06 6.5396188279e+06 6.7339033950e+06 6.9339599334e+06 7.1399599219e+06 7.3520799336e+06 7.5705017873e+06 7.7954127034e+06 8.0270054647e+06 8.2654785810e+06 8.5110364597e+06 8.7638895812e+06 9.0242546785e+06 9.2923549240e+06 9.5684201199e+06 9.8526868959e+06 1.0145398911e+07 1.0446807065e+07 1.0757169708e+07 1.1076752870e+07 1.1405830480e+07 1.1744684608e+07 1.2093605703e+07 1.2452892844e+07 1.2822853992e+07 1.3203806262e+07 1.3596076187e+07 1.4000000000e+07 ) 

# The group structure to use outside the RRR in the thermal and fast energy ranges. 
# G=shem-361 would point to ../dat/energy_groups/shem-361.txt 
G=log-1-798-1 
 
# How many Legendre moments to use for the scattering transfer matrices 
L=7 

# Which clustering algorithm to use. Recommended: use 'tmg' for MG XS and 'har' for FEDS XS 
# Use './indicators_clustering.py -h' for more information. 
clusterer=har 

# Which apportioning algorithm to use. Recommended: use 'var' for FEDS and 'L1' or 'max' for MG XS 
# Use './indicators_clustering.py -h' for more information. 
appt=var 
 
# Which reactions to include in the PDT XS file. Recommended: use 'abs' if absorption edits are needed 
# Use './materials.py -h' for more information 
rxnOpt=invel 

# Use './materials.py -h' for more information 
weightOpt=(2) 
#weightOpt=(4 .1265 .0253 .1265 1.4e6) 
 
############################ 
# GENERATE CROSS SECTIONS 
############################ 
 
#NB: In many cases, if a previous step has run successfully, you don't need 
# to rerun it to run a later step if you make changes that affect that later 
# step only. 
echo '                  (         )   (      (      (           ' 
echo '   (      (       )\ )   ( /(   )\ )   )\ )   )\ )        ' 
echo ' ( )\     )\     (()/(   )\()) (()/(  (()/(  (()/(   (    ' 
echo ' )((_) ((((_)(    /(_)) ((_)\   /(_))  /(_))  /(_))  )\   ' 
echo '((_)_   )\ _ )\  (_))    _((_) (_))_| (_))   (_))   ((_)  ' 
echo ' | _ )  (_)_\(_) | _ \  | \| | | |_   |_ _|  | _ \  | __| ' 
echo ' | _ \   / _ \   |   /  | .` | | __|   | |   |   /  | _|  ' 
echo ' |___/  /_/ \_\  |_|_\  |_|\_| |_|    |___|  |_|_\  |___| ' 
echo 
echo '------- Step 0: Initializing the scratch directory -------' 
scriptdir=`pwd` 
srcdir=/home/pablo/barnfire/src 
cd $srcdir
./Initialize.py $scriptdir $0 
 
echo '------- Step 1: Generating the NJOY inputs -------' 
mList=${mIMPORTANTlist[*]} 
./materials.py -m ${mList[*]} -W ${weightOpt[*]} -v 
 
echo '------- Step 2: Running NJOY to generate the PENDF file -------' 
cd $SCRATCH_BARN/xs 
./RunPendf.sh 
cd $srcdir 
 
if [ "${unimportantMatsExist}" = 1 ] 
then 
    echo '------- Step 1: Generating the NJOY inputs -------'  
    mList=${mUNIMPORTANTlist[*]} 
    ./materials.py -m ${mList[*]} -W ${weightOpt[*]} -v  
      
    echo '------- Step 2: Running NJOY to generate the PENDF files -------'  
    cd $SCRATCH_BARN/xs 
    ./RunPendf.sh  
    cd $srcdir  
fi 
 
echo '------- Step 3: Generating the indicators and their energy grid -------' 
./indicators.py -R ${c[0]} ${c[*]: -1} -m $m -w flux -r $res -G $G -v -Z -s $bin 
 
echo '------- Step 4: Generating more indicators on the same energy grid but using escape XS -------' 
./indicators.py -R ${c[0]} ${c[*]: -1} -m $m -w sigt -r $res -G $G -v -Z -s $bin
 
echo '------- Step 5: Clustering the indicators to get the clust file, which specifies the energy mesh -------' 
./indicators_clustering.py -c ${c[*]} -e $g -m $m -w $clusterer -E $penalty -r $res -a $appt -v 3 -d 500 -S -p none  
 
echo '------- Step 6: Generating the weighting spectrum on the subelements -------' 
./indicators.py -R ${c[0]} ${c[*]: -1} -m $m -w wgt -r $res -G $G -v -Z -s $bin -M clust-$g-$res 
 
# Do for important materials: 
mList=${mIMPORTANTlist[*]} 
echo '------- Step 7: Regenerating NJOY inputs with a group structure of the subelements -------'  
./materials.py -m ${mList[*]} -G clust-$g-$res -L $L -W ${weightOpt[*]} -v  
echo '------- Step 8: Running NJOY to generate GENDF files (on the subelements) -------'  
cd $SCRATCH_BARN/xs 
./RunGendf.sh 
echo '------- Step 9: Summing/averaging over the subelements to get PDT-formatted FEDS XS on the elements -------'  
cd $srcdir 
./materials.py -b -m ${mList[*]} -p $rxnOpt -M clust-$g-$res -W ${weightOpt[*]} -v 
 
if [ "${unimportantMatsExist}" = 1 ] 
then 
    # Do for unimportant materials: 
    mList=${mUNIMPORTANTlist[*]} 
    echo '------- Step 7: Regenerating NJOY inputs with a group structure of the subelements -------'  
    ./materials.py -m ${mList[*]} -G clust-$g-$res -L $L -W ${weightOpt[*]} -v  
    echo '------- Step 8: Running NJOY to generate GENDF files (on the subelements) -------'  
    cd $SCRATCH_BARN/xs 
    ./RunGendf.sh 
    echo '------- Step 9: Summing/averaging over the subelements to get PDT-formatted FEDS XS on the elements -------'  
    cd $srcdir 
    ./materials.py -b -m ${mList[*]} -p $rxnOpt -M clust-$g-$res -W ${weightOpt[*]} -v 2 
fi 
 
echo ' The result should be a list of .data files in $scratch/xs/pdtxs ' 
 
####################### 
sleep 0.1 
 
cp $SCRATCH_BARN/xs/pdtxs/BarnfireXS_HMF001_800.xml $scriptdir/heu20_800mg/. 
cp $SCRATCH_BARN/dat/indicators/flux.xml $scriptdir/heu20_800mg/flux_1th_798cg_798el_1urr.xml 
cp $SCRATCH_BARN/dat/energy_groups/clust-$g-$res.xml $scriptdir/heu20_800mg/clust_1th_798cg_798el_1urr.xml
#######################
rm *.~ *.pyc
